from brian import *
from time import time
dt_ =1.0
simclock = Clock(dt=dt_*ms)
monclock = Clock(dt=dt_* ms)
n=[32,50,3]
maxN=max(n)
#ipLayerConnWeights=[[1.9412184,4.1795526,3.0952506,0.61516464,2.6531556,4.1255765,3.7149906,3.758751,1.0907084,1.8980443,0.77892363,0.9812087,4.3939657,2.8641965,3.6068776,0.21113932,1.574533,0.51753104,3.774505,4.636835,0.4207185,1.6543525,2.8538814,3.9915206,0.28227806,2.547321,3.4007516,2.6654081,0.14503896,2.1693811,4.1799064,4.4461384],[1.7873535,1.1653159,2.6944656,4.5045576,0.81680447,3.2357683,0.29616654,2.9625108,1.5607911,3.6800466,2.1163704,1.45751,2.1256926,3.2199688,2.9637504,1.0255313,1.1463714,0.7187441,2.205086,0.09309262,2.47422,0.72830945,1.5788227,2.654195,1.15417,4.7982187,2.3138676,0.82326114,0.82867295,3.4022427,1.8433521,0.934079],[2.192302,4.0691013,4.647795,3.4948478,4.270157,4.6156135,0.24540067,3.4241662,3.2755928,1.1890469,4.3083577,1.6613326,0.24005234,2.43628,4.140386,2.061335,1.8250968,3.4767804,3.9478674,0.3107962,4.0024967,4.301333,0.19836098,4.8118157,4.103831,3.7264206,0.937925,3.2178009,1.03107,4.473334,0.8622351,3.7261314],[4.8217864,1.3202856,0.6641343,0.7598144,0.8676928,4.4943895,4.248008,2.242535,4.687228,0.5684367,1.673547,1.9928801,3.4988093,4.535564,2.6104462,3.55366,4.881482,2.5245066,1.9218129,1.0165956,1.447252,0.75102746,3.096294,1.6020956,2.7908611,2.879887,0.29377192,2.1750593,0.587748,0.48951507,2.0119596,1.8028152],[3.842073,1.9221518,3.904232,1.4382992,0.15986025,3.4900749,0.24378836,4.903864,4.956402,2.9586194,4.4249387,2.3877983,2.5742116,2.9947588,2.786381,4.4914446,0.9631422,3.052258,0.8292398,4.590084,1.386173,1.0478137,4.5580764,1.5215054,1.2942231,4.39467,1.497719,4.783944,1.2457607,2.1190982,2.8125825,2.917172],[0.41963935,1.149677,0.5860716,2.2296944,1.723306,3.5888708,3.4918818,0.7098371,1.7772701,0.14108211,1.9207561,3.7730172,2.6575422,0.5617437,4.807915,3.4214437,1.4008391,4.32945,3.4584615,1.6612401,2.076056,0.93953073,1.1891884,2.3864841,4.0562387,0.6253123,1.5221927,2.9165316,3.7976398,4.675865,4.483312,2.4944556],[1.4591157,3.2199712,1.6097772,3.1183395,0.541887,3.6598816,1.9676447,4.396992,4.0655794,0.28012812,1.5598605,4.7764974,4.7434506,0.73193103,2.2875614,3.5686197,0.003066957,0.5488488,3.2559607,1.086776,3.2967055,2.921194,0.91552943,0.73605955,1.9398719,2.1229103,0.8509153,4.7522674,4.141119,0.113235116,1.1040372,3.0982242],[0.07951468,3.4353738,1.7020545,3.7268221,1.938464,1.0049489,4.591564,1.4475396,2.0100899,1.2622604,0.8217007,1.1908829,2.0900667,3.385018,3.5131624,4.7729406,2.8389204,2.393494,0.66809595,0.80539405,1.9956193,0.48990756,1.0658481,1.1758711,1.8992927,4.4608226,0.528619,0.30607313,0.7646367,4.428595,3.4838886,1.9628439],[0.3287381,2.2992084,3.580161,1.7981865,3.5574768,1.4436436,4.790202,4.5915937,1.9872785,4.133225,4.950791,0.6910646,4.3548965,2.0818892,3.6074715,4.742585,3.5092437,1.8262818,0.7523376,2.0719478,1.2334543,2.1849325,3.0362,3.1636028,2.7637193,1.4080443,1.1052897,3.4603605,1.1586213,2.9777815,0.23683012,4.0923953],[3.636367,4.104191,4.63541,1.3070494,1.8982977,0.4334128,1.8891692,4.0008044,3.8393233,4.1327085,2.785721,0.3056416,1.906496,0.5216807,0.14475793,2.1235518,1.4060595,2.602202,4.558036,4.570509,4.930272,2.912916,1.0364401,2.7358184,4.6345434,1.9502316,0.97494334,3.0009482,4.6525593,1.1997213,3.5642834,3.4259872],[4.504731,2.493495,3.6362,2.6996188,0.8993715,2.7248847,2.838131,3.6733973,3.0153701,1.8266954,3.232697,4.142297,2.8119302,0.6589964,4.724446,3.885677,0.46028107,4.003231,1.7767189,4.9063416,0.9125665,0.058270097,2.4187422,1.6762054,4.395738,3.6583853,1.6089326,0.15688956,4.177841,3.2512279,2.244781,4.569477],[2.938262,0.49447626,4.9505844,2.7626226,0.07313132,3.0523286,1.7678461,1.5106225,0.076078475,1.8374763,4.8836145,3.8670735,1.13248825E-5,4.981284,3.0017853,4.525058,0.87770313,0.295884,2.1619248,0.97678214,4.761072,1.8787124,2.0881531,1.6252253,4.8375454,4.90519,2.1837842,0.144203,4.456393,1.0519519,4.3306527,2.5935965],[1.1111253,2.525047,2.7883644,1.62114,4.691699,0.35927057,4.8792334,0.58460444,0.0614509,1.6713154,1.2786617,4.437563,1.1003184,0.446364,0.6755531,4.5828815,1.363278,3.4114184,3.2185624,4.721027,1.9593563,0.68595886,3.495177,0.6311691,4.893442,3.429009,1.1035693,0.2135104,4.1150846,1.2394931,2.051743,3.3984842],[1.7731347,0.8727136,2.962716,4.3653436,0.52336544,3.0592675,3.1644735,4.097603,4.2219424,3.1437755,4.313455,2.5899909,3.457998,1.580117,2.9327855,0.9806597,4.3336687,1.3486984,1.6618035,0.7488218,0.8431873,3.311576,3.710391,4.6426196,3.4903965,3.7455368,1.9168037,1.7015809,4.225922,2.5346618,1.4261589,2.1446242],[0.893949,4.1462655,4.671351,4.8061423,0.61985373,2.8318346,0.46013892,1.5326786,1.6128504,3.902697,3.2907057,0.5802199,1.8243468,0.23432732,4.850542,1.6718733,1.6180847,4.799713,1.1455077,3.3480654,3.8506894,1.3579869,0.081091225,1.4423192,4.5123925,0.9071064,1.1278799,3.5867822,0.7720214,1.0169029,4.078049,2.2501922],[2.0455468,0.2001229,4.7972035,3.8597357,1.6543605,4.4535317,4.332356,3.4957626,3.0519888,1.5488338,2.1164157,2.6786492,1.2231755,4.504681,0.25470138,2.1100173,3.1474018,4.4977517,3.7601776,4.37131,4.5732765,3.7346363,0.9699708,4.5224457,0.37724763,3.1096525,0.40302992,0.048435926,3.5393617,0.80987096,3.7624154,2.4548042],[0.022986531,1.0313392,2.2286532,0.061071515,2.310382,4.164204,2.2940004,2.749136,4.940639,2.8541448,2.140608,1.9190266,2.4929526,4.308923,1.535787,1.033057,1.1315578,1.7882357,2.8004446,4.501177,3.1073654,3.9793074,3.0758297,4.401292,1.7267051,0.64733356,0.6708202,4.5300817,3.9343202,2.6771653,0.0969553,4.449677],[1.2034442,2.1492615,4.699276,4.706209,1.2213182,4.0683813,0.8539194,3.9363136,0.44778705,0.57774454,3.142586,4.601164,3.0047317,1.1251664,2.9218254,3.0642881,2.225235,4.922203,4.3020887,0.39466977,2.2068744,4.8646,2.8363154,4.881354,0.7298085,3.7148075,0.6171763,2.8066466,4.22699,3.0282192,2.0009336,3.5741901],[3.1435356,3.9178455,0.6471288,4.123591,1.9608623,0.071828365,4.8981895,4.4983335,0.5576366,0.37950486,4.9607253,0.047558248,0.055857003,4.3903637,4.708234,0.62960356,0.1818201,3.5724573,4.8485847,0.20640135,1.7365003,2.789562,4.412693,1.7488239,0.49955964,1.5571651,2.0749414,2.5555184,0.7202783,0.8343467,3.3410883,0.07885575],[0.9149158,2.3706274,3.593564,1.5742204,2.5841663,0.85325986,4.9034038,4.2814536,2.4804087,0.33131927,2.2667952,3.1139226,4.4394546,2.058929,0.94474226,2.6911669,1.495646,4.072363,3.1471853,4.9907236,3.925775,4.456477,1.7566502,1.41449,3.1228554,0.46751738,4.8079624,1.9315305,3.3447833,4.954944,3.2845664,3.4546952],[2.678165,1.9983524,1.541574,1.2807441,2.2197912,0.37120312,4.4819903,1.3362565,2.9264185,0.52601695,4.9848127,1.9536188,1.6896996,2.8215182,3.0793438,2.7974916,1.5325167,2.8773036,2.8745313,3.4827626,1.9239094,3.3328104,2.2591305,1.9960421,3.8037071,3.1322436,3.1897113,4.6458473,4.1794567,4.37385,3.8588896,2.329023],[1.9949498,3.0092587,3.8936706,2.0854416,2.2124386,1.4060225,0.75956196,1.4081552,3.7434359,0.28393894,1.8544295,3.536,3.5028677,2.4839673,2.0592766,3.949925,3.6485126,0.74879557,4.291793,2.7583628,4.1554117,3.3983076,4.481199,4.3417835,3.6197402,1.8238912,2.276434,4.0487585,2.398045,3.8458576,2.2189546,2.4276319],[4.3784723,0.56201935,3.3892906,3.237121,4.3164625,2.6370983,0.08429706,3.6193109,2.4173255,0.45716584,4.6388445,4.418657,1.8341687,2.0063841,1.3890398,2.785544,3.7970753,0.1612544,2.1293485,2.2729344,1.9764912,2.6772544,2.4669375,0.4957509,3.3919768,2.9417334,0.77483386,3.716382,3.1413124,2.4533894,0.12106091,0.10339141],[0.58219314,3.4713373,0.5617395,4.8069215,3.4401608,1.7551615,1.5683526,4.8419533,4.9359694,3.3314056,0.47725558,4.273572,3.1703591,4.7023983,3.6454365,0.57644814,3.124375,3.4314218,2.2409842,3.7792096,3.1322422,4.055887,4.1383767,2.1042373,1.1678976,0.39998472,3.404283,2.041268,2.815043,2.5733213,3.103972,3.931248],[4.1268425,4.8862,3.2146585,0.23302078,2.4408526,2.1097853,0.961307,0.2631095,3.51647,2.6255336,4.881834,4.667179,0.47813684,0.09856671,2.9496517,3.5454688,1.0529608,4.070446,4.527634,4.623903,3.5146089,0.88496596,1.2724501,1.2637236,0.81778556,0.3636703,0.15356898,3.3269129,3.31383,1.7539682,1.8770089,1.8696314],[0.5657083,2.4407885,3.4180286,3.4942503,1.4707315,0.39203316,2.3556364,2.6407363,1.6956353,1.0887939,2.8792386,0.59432954,0.32831728,1.9539347,0.8963594,4.998276,1.3536892,3.8586192,4.6306477,1.92328,4.721131,4.867496,3.559988,1.310216,4.2443523,4.8321524,4.9321685,2.8861775,2.6706386,0.0022241473,3.4151711,1.4882696],[0.98820597,0.37804276,4.523704,3.4126153,4.373503,2.8522623,0.22421807,2.7512622,4.283745,3.1956508,0.7966536,2.266164,2.6957912,2.939755,3.4398613,1.7718985,3.7059355,3.1427722,1.8945879,0.11763096,4.9144726,3.731614,4.2467394,0.049989223,4.7056437,1.5703139,1.1160547,3.6436155,4.6321564,4.980856,4.2612925,0.7624087],[2.2617314,1.1458838,0.70047677,2.584723,4.631805,2.553084,4.289871,3.5285332,4.681595,0.43830276,1.1923637,4.651892,0.93526244,3.479361,1.2372575,2.4996433,3.2460876,1.8563241,1.0995617,4.40465,0.48273087,1.188623,4.8564215,2.931736,3.7512279,2.887397,1.4880359,1.7417014,4.659921,2.6159585,3.5352268,1.9334378],[1.5117937,3.966092,1.4886725,3.4421144,3.3654034,0.15748024,4.7269225,0.39416552,2.0608306,1.7168474,3.4308558,2.2744763,4.432768,2.2481978,0.94864756,0.19242764,0.6043166,3.7619877,0.4630825,2.5517235,1.000525,1.6761897,1.4958081,3.6601233,4.2716646,0.76349944,0.07262528,3.65097,4.8572326,0.61456174,3.1500654,0.93592376],[2.34043,2.875842,3.874277,3.9405048,1.8801755,0.7520771,0.19480765,0.2793044,0.90755105,1.3271067,2.4024556,1.7602232,1.4329793,0.83400965,4.9943633,1.6365144,4.9296355,1.4171332,3.4114618,2.587119,4.990868,2.386693,0.24184257,4.7507544,2.1612546,0.82372427,3.36544,2.2840617,0.32184184,2.392397,2.735384,4.891048],[0.28289884,1.7418919,4.3825965,0.3779295,1.2678716,4.205572,1.2037024,1.83779,0.4292035,2.046105,2.8874924,4.642281,4.5422845,0.05718112,2.2692325,1.1076531,2.4032328,4.3618064,1.6207337,3.870089,3.987821,0.0807333,4.1107855,0.5265361,4.094072,2.6599896,3.4571338,4.613671,4.4244266,3.9118156,1.7675242,0.16645223],[0.0026604533,3.7474313,3.6914446,4.841795,1.5566578,1.5623206,1.3121843,4.3507295,1.324755,0.81520736,2.064999,2.918043,1.4076517,0.45123875,2.3138742,0.90162754,2.7400904,3.0294046,1.8271112,4.039872,2.3999236,0.18579423,4.1093926,0.055455863,3.9132757,4.000491,0.5518609,3.294405,0.5128437,0.9298691,1.4069015,3.5024896]]
#hdLayerConnWeights=[[1.6595211,4.1984377,2.7034316],[1.6924196,0.9051135,3.9421868],[0.35460532,2.8432965,2.5460463],[3.6980133,2.4952974,4.9592743],[4.5578814,3.4367552,0.05090803],[2.0360832,4.1808357,3.4416614],[3.9147477,1.399759,2.1255028],[4.599387,4.787955,2.7177577],[3.0927587,1.1385133,3.2809641],[3.2485197,0.04799038,1.1783776],[0.77252805,3.673382,1.5834445],[4.074004,3.0590127,4.1221604],[2.092501,1.2421381,3.2665744],[3.4318676,1.730389,3.132943],[3.5888865,0.1975295,3.1895745],[4.4915447,3.6035724,2.3562317],[4.9453406,0.5186343,4.6147013],[1.3522601,0.67653,3.9907565],[1.2730742,4.9650474,3.2148168],[3.6053298,4.7001343,2.6357648],[2.3780978,3.5550644,2.2478893],[3.2365823,1.9826231,2.659148],[1.5820148,0.21329105,4.865512],[0.84780127,2.8973255,4.5621653],[4.873505,3.7417078,4.13605],[4.2313128,3.0526547,0.83307296],[2.155095,2.9615974,2.1025636],[4.9710603,1.9069868,3.8894415],[4.011494,4.6070457,3.0919442],[4.150974,2.4668274,4.4561133],[1.0900766,2.3722079,3.5189219],[4.787751,3.680751,4.06207]]
spikeTimesIter = [[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[14.0,34.0,56.0,73.0,96.0,114.0,133.0,154.0,173.0,197.0],[14.0,34.0,56.0,73.0,96.0,114.0,133.0,154.0,173.0,197.0],[15.0,35.0,53.0,77.0,93.0,115.0,137.0,155.0,176.0,193.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,198.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[16.0,37.0,58.0,76.0,97.0,116.0,137.0,157.0,176.0,198.0],[16.0,37.0,58.0,76.0,97.0,116.0,137.0,157.0,176.0,198.0],[17.0,36.0,55.0,77.0,96.0,116.0,136.0,156.0,176.0,195.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,98.0,310.0,136.0,158.0,370.0,390.0],[11.0,30.0,50.0,71.0,89.0,113.0,128.0,149.0,172.0,191.0],[11.0,30.0,50.0,71.0,89.0,113.0,128.0,149.0,172.0,191.0],[11.0,32.0,52.0,71.0,93.0,109.0,136.0,153.0,170.0,191.0],[210.0,230.0,250.0,270.0,290.0,118.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[18.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[15.0,35.0,55.0,75.0,95.0,115.0,135.0,155.0,175.0,195.0],[15.0,35.0,55.0,75.0,95.0,115.0,135.0,155.0,175.0,195.0],[18.0,38.0,58.0,78.0,98.0,118.0,138.0,158.0,178.0,198.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0],[210.0,230.0,250.0,270.0,290.0,310.0,330.0,350.0,370.0,390.0]]
spikeTimes = [(i, t*ms) for i in xrange(len(spikeTimesIter)) for t in spikeTimesIter[i]]

k=0.571/ms/mV
a=0.13
b=-2.714
d=111.506
C=81.2
vR=-60.5*mV
vT=-34.8*mV
vPeak=42.4*mV
c=-60.0*mV
Is=0
simDur=400

model9pEqs= Equations('''
        dV/dt=(k*((V-vR)*(V-vT))-U+I)/(C) : mV
        dU/dt=a*((b*(V-vR)/ms/ms)-(U/ms)) : mV/ms
        I : mV/ms
        ''')

eqs_stdp='''
dA_pre/dt=-A_pre/tau_stdp : 1
dA_post/dt=-A_post/tau_stdp : 1
'''

inputLayer = SpikeGeneratorGroup(n[0], spikeTimes, clock=simclock)
hiddenLayer = NeuronGroup(n[1], model=model9pEqs, threshold="V>vPeak", reset="V=c;U+=d", method= "RK", clock=simclock)
outputLayer = NeuronGroup(n[2], model=model9pEqs, threshold="V>vPeak", reset="V=c;U+=d", method= "RK", clock=simclock)

conn1 = Connection(inputLayer, hiddenLayer, 'V', weight=10.0*mV, sparseness=1.0)
#conn1_5= Connection(hiddenLayer, hiddenLayer, 'V', )
conn2 = Connection(hiddenLayer, outputLayer, 'V')
#conn1.connect_full(weight = 5.0*mV);
conn2.connect_full(weight = 1.0*mV);

tau_stdp = 100.0*ms
gmax = 1000*mV
stdp=STDP(conn1,eqs=eqs_stdp,pre='A_pre+=0.5;w+=A_post*mV',post='A_post+=0.5;w+=A_pre*mV',wmax=gmax, clock=simclock)
#stdp2=STDP(conn2,eqs=eqs_stdp,pre='A_pre+=0.1;w+=A_post*mV',post='A_post+=0.1;w+=A_pre*mV',wmax=gmax, clock=simclock)
SMO = SpikeMonitor(outputLayer)

SMI = SpikeMonitor(inputLayer)
SM = SpikeMonitor(hiddenLayer)
VM = StateMonitor(outputLayer, 'V', record=True, clock=monclock) 

hiddenLayer.V = vR 
hiddenLayer.U =0
outputLayer.V = vR 
outputLayer.U =0

print conn1[2,0]
t1 = time()
run(simDur*ms)
t2 = time()
print conn1[2,0]

print "Simulation time:", t2 - t1, "s"
print "Output Layer Spike times:"
for i in xrange(0, n[len(n)-1]):
    print str(SMO[i])

doPlotOpLayer = True
doPlotRaster = True

if doPlotRaster:
    colors=[0,0,0]
    subplot(311)
    raster_plot(SMI, title='Input Layer')
    axis([0, simDur, 0, n[0]])
    subplot(312)
    raster_plot(SM, title='Hidden Layer')
    axis([0, simDur, 0, n[1]])
    subplot(337)
    plot(VM.times / ms, VM[0] / mV, lw=1.0, color=colors)
    xlabel('Time (ms)')
    ylabel('V (mV)')
    subplot(338)
    plot(VM.times / ms, VM[1] / mV, lw=1.0, color=colors)
    subplot(339)
    plot(VM.times / ms, VM[2] / mV, lw=1.0, color=colors)
show()
###
##
###
stdp = None
print conn1[2,0]
t1 = time()
run(simDur*ms)
t2 = time()
print conn1[2,0]

print "Simulation time:", t2 - t1, "s"
print "Output Layer Spike times:"
for i in xrange(0, n[len(n)-1]):
    print str(SMO[i])

doPlotOpLayer = True
doPlotRaster = True

if doPlotRaster:
    colors=[0,0,0]
    subplot(311)
    raster_plot(SMI, title='Input Layer')
    axis([0, simDur, 0, n[0]])
    subplot(312)
    raster_plot(SM, title='Hidden Layer')
    axis([0, simDur, 0, n[1]])
    subplot(337)
    plot(VM.times / ms, VM[0] / mV, lw=1.0, color=colors)
    xlabel('Time (ms)')
    ylabel('V (mV)')
    subplot(338)
    plot(VM.times / ms, VM[1] / mV, lw=1.0, color=colors)
    subplot(339)
    plot(VM.times / ms, VM[2] / mV, lw=1.0, color=colors)
show()